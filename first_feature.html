<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>First feature | Laravel URL Shortener Guide</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/tinyuri/assets/css/0.styles.d2ccf6e6.css" as="style"><link rel="preload" href="/tinyuri/assets/js/app.3bb2924c.js" as="script"><link rel="preload" href="/tinyuri/assets/js/2.a48eb182.js" as="script"><link rel="preload" href="/tinyuri/assets/js/13.9ce1fb47.js" as="script"><link rel="prefetch" href="/tinyuri/assets/js/10.6d1ed9c6.js"><link rel="prefetch" href="/tinyuri/assets/js/11.95d99df8.js"><link rel="prefetch" href="/tinyuri/assets/js/12.f1f697df.js"><link rel="prefetch" href="/tinyuri/assets/js/14.4cebca7a.js"><link rel="prefetch" href="/tinyuri/assets/js/15.3a6bf7d5.js"><link rel="prefetch" href="/tinyuri/assets/js/16.09b13ee9.js"><link rel="prefetch" href="/tinyuri/assets/js/17.37ce4089.js"><link rel="prefetch" href="/tinyuri/assets/js/18.7b9085b3.js"><link rel="prefetch" href="/tinyuri/assets/js/19.bd1170b4.js"><link rel="prefetch" href="/tinyuri/assets/js/20.4a35bc46.js"><link rel="prefetch" href="/tinyuri/assets/js/3.f153be8f.js"><link rel="prefetch" href="/tinyuri/assets/js/4.4d31d94d.js"><link rel="prefetch" href="/tinyuri/assets/js/5.4e7a2df9.js"><link rel="prefetch" href="/tinyuri/assets/js/6.498ab014.js"><link rel="prefetch" href="/tinyuri/assets/js/7.7e550121.js"><link rel="prefetch" href="/tinyuri/assets/js/8.fbde365e.js"><link rel="prefetch" href="/tinyuri/assets/js/9.b751af4a.js">
    <link rel="stylesheet" href="/tinyuri/assets/css/0.styles.d2ccf6e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tinyuri/" class="home-link router-link-active"><!----> <span class="site-name">Laravel URL Shortener Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tinyuri/" class="nav-link">
  Guide
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tinyuri/" class="nav-link">
  Guide
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tinyuri/setting_up.html" class="sidebar-link">Setting up a project</a></li><li><a href="/tinyuri/mvp_design.html" class="sidebar-link">Planning</a></li><li><a href="/tinyuri/mvp_code.html" class="sidebar-link">Getting Started with Code</a></li><li><a href="/tinyuri/basic_style.html" class="sidebar-link">Basic styling</a></li><li><a href="/tinyuri/first_feature.html" aria-current="page" class="active sidebar-link">First feature</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tinyuri/first_feature.html#thinking-past-base10" class="sidebar-link">Thinking past base10</a></li><li class="sidebar-sub-header"><a href="/tinyuri/first_feature.html#planning-the-implementation" class="sidebar-link">Planning the implementation</a></li><li class="sidebar-sub-header"><a href="/tinyuri/first_feature.html#creating-base-conversion" class="sidebar-link">Creating base conversion</a></li><li class="sidebar-sub-header"><a href="/tinyuri/first_feature.html#writing-tests-for-our-new-feature" class="sidebar-link">Writing tests for our new feature</a></li><li class="sidebar-sub-header"><a href="/tinyuri/first_feature.html#factories" class="sidebar-link">Factories</a></li><li class="sidebar-sub-header"><a href="/tinyuri/first_feature.html#explicit-binding-and-scopes" class="sidebar-link">Explicit binding and Scopes</a></li></ul></li><li><a href="/tinyuri/cleanup.html" class="sidebar-link">Refactoring</a></li><li><a href="/tinyuri/users.html" class="sidebar-link">Authentication</a></li><li><a href="/tinyuri/relationships.html" class="sidebar-link">Relationships</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="first-feature"><a href="#first-feature" class="header-anchor">#</a> First feature</h1> <h2 id="thinking-past-base10"><a href="#thinking-past-base10" class="header-anchor">#</a> Thinking past base10</h2> <p>Now that we have a working basic MVP, we want to start considering and planning our first additional feature to make this product slightly more useable. We mentioned prior but using base10 for our identifiers for our shortened urls is less than ideal, we only get 0-9 per character after our root url which is 10 potential characters, so after 10 rows in our database we are up to a url id that is two characters long. If we were to use 0-9 a-z and A-Z we move from base10 to base62 (10 + 26 + 26). It is pretty common for url shorteners to use base62 but lets just think about why. Once we have 100 rows in our database a base10 <code>id</code> will be 3 characters long while a base62 <code>id</code> will only be 2 characters long: <code>1C</code>. Having a much higher base will help us keep our URLs short!</p> <h2 id="planning-the-implementation"><a href="#planning-the-implementation" class="header-anchor">#</a> Planning the implementation</h2> <p>So there are a few ways we can implement this, immediately we could be adding a new column called something like <code>hash</code> that could represent the <code>base62</code> id for our row in the database, we could index this column to ensure we can look it up quickly. But we would also have to consider how we would go about generating these hashes. We'd need to make sure they are unique and incrementing properly. These present some difficulty because they would require querying the database to figure out what the next <code>base62</code> hash would be.</p> <p>If we think about it though we already have something that pretty much fits all of our requirements, the auto-incrementing, unique and indexed column in our tiny table. Thats the primary key column <code>id</code>. If we are going to continue to use the <code>id</code> column we need to adjust two things to make it work.</p> <ol><li>We need to be able to return to the user the <code>base62</code> version of our ids</li> <li>We need to be able to look up our urls table entries given a <code>base62</code> id.</li></ol> <h2 id="creating-base-conversion"><a href="#creating-base-conversion" class="header-anchor">#</a> Creating base conversion</h2> <p>We have identified that we need two functions two make this work, something two convert base10 to base62 and one to convert base62 to base10. Lets start with base10 to base62:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function">base62</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
  <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
  <span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token variable">$base</span><span class="token punctuation">[</span><span class="token variable">$num</span> <span class="token operator">%</span> <span class="token number">62</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
    <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$num</span> <span class="token operator">/</span> <span class="token number">62</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>if we test this out we should see <code>base62(100) == 1C</code>.</p> <p>and then to create the inverse we are going to need to do something like the following:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">function</span> <span class="token function">to10</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token variable">$base</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
  <span class="token variable">$limit</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$num</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$limit</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token number">62</span> <span class="token operator">*</span> <span class="token variable">$res</span> <span class="token operator">+</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token variable">$base</span><span class="token punctuation">,</span> <span class="token variable">$num</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>if we test this out we should see <code>to10(base62(100)) == 100</code>. Now that we have these functions lets add them as some private functions on our Url model. This might not be an ideal place for them but we really just want to get this working. First lets add a constant to the top of the file so we have the same <code>$base</code> being used by both functions so we don't have any mistakes going back and forth as the order matters for translation between.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// app/Models/Url.php</span>

<span class="token keyword">class</span> <span class="token class-name">Url</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">HasFactory</span><span class="token punctuation">;</span>

    <span class="token keyword">const</span> <span class="token constant">BASE</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>now lets add these two private functions to the bottom of our class:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">base62</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>

    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token constant">BASE</span><span class="token punctuation">[</span><span class="token variable">$num</span> <span class="token operator">%</span> <span class="token number">62</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
        <span class="token variable">$num</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$num</span> <span class="token operator">/</span> <span class="token number">62</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">to10</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$limit</span> <span class="token operator">=</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token variable">$num</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token constant">BASE</span><span class="token punctuation">,</span> <span class="token variable">$num</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token variable">$i</span> <span class="token operator">&lt;</span> <span class="token variable">$limit</span><span class="token punctuation">;</span> <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token variable">$res</span> <span class="token operator">=</span> <span class="token number">62</span> <span class="token operator">*</span> <span class="token variable">$res</span> <span class="token operator">+</span> <span class="token function">strpos</span><span class="token punctuation">(</span><span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token constant">BASE</span><span class="token punctuation">,</span> <span class="token variable">$num</span><span class="token punctuation">[</span><span class="token variable">$i</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token variable">$res</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="writing-tests-for-our-new-feature"><a href="#writing-tests-for-our-new-feature" class="header-anchor">#</a> Writing tests for our new feature</h2> <p>Now that we have these two functions lets make some tests for our next steps. We are going to want to make some unit tests and update some feature tests. Lets start with the unit tests for our desired outcome.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>php artisan make:test UrlTest --unit
</code></pre></div><p>And then we are going to make some adjustments to the new file and write our first test:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">Tests<span class="token punctuation">\</span>Unit</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">Tests<span class="token punctuation">\</span>TestCase</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Url</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UrlTest</span> <span class="token keyword">extends</span> <span class="token class-name">TestCase</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">test_url_base62_returns_urls_base62_version_of_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token function">make</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'id'</span> <span class="token operator">=&gt;</span> <span class="token number">100</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'https://www.google.com'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'1C'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token function">base62id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div><p>If we run the test now we should see:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>BadMethodCallException: Call to undefined method App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Url::base62id<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><p>Now if we add some code to return the <code>base62id</code>:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// app/models/Url.php</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">base62id</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">base62</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This is just converting the model's id to base62 and returning it so lets give it another shot:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Failed asserting that two strings are equal.
--- Expected
+++ Actual
@@ @@
-<span class="token string">'1C'</span>
+<span class="token string">'1'</span>
</code></pre></div><p>So this is not working as expected. Looking at the output it looks as if we are returning <code>id</code> 1 which implies we are possibly not setting a different id in our test. That's because <code>id</code> is not a <a href="https://laravel.com/docs/8.x/eloquent#mass-assignment" target="_blank" rel="noopener noreferrer"><code>fillable</code><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> property, we can add <code>id</code> to fillable which would allow it to be set by form input or we can just set the <code>id</code> in code. For now lets just update the test and see if that works:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$url</span> <span class="token operator">=</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'https://www.google.com'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token property">id</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
<span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">assertEquals</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'1C'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token function">base62id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>And now we see our test pass! Thats great, our next step is going to be to start returning that in our view instead of the <code>id</code>. Let's update our redirect with session data:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// routes/web.php</span>

<span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlId'</span> <span class="token operator">=&gt;</span> <span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token function">base62id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now if we run the tests again do you think they are going to pass or fail? We have changed the logic in our route and are asserting that we attach the <code>id</code> even though we are now calling <code>$url-&gt;base62id()</code>. If we run the tests they are still going to pass, that's because 1 is 1 in <code>base10</code> and <code>base62</code>. Let's figure out a way we can ensure this test would fail unless we changed the test(<code>tests/Feature/UrlTest.php</code>) to start looking for the <code>base62id</code>.</p> <h2 id="factories"><a href="#factories" class="header-anchor">#</a> Factories</h2> <p>To help improve testing with ease Laravel has some helpful tools at its disposal such as <a href="https://laravel.com/docs/8.x/database-testing#defining-model-factories" target="_blank" rel="noopener noreferrer">model factories<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that help you generate fake data with ease and default data. Let's go ahead and make a UrlFactory tied to our Url model:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>php artisan make:factory UrlFactory --model<span class="token operator">=</span>Url
</code></pre></div><p>if we now look in out <code>database/factories/</code> folder we should see a new file: <code>UrlFactory.php</code> lets take a look:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token keyword">namespace</span> <span class="token package">Database<span class="token punctuation">\</span>Factories</span><span class="token punctuation">;</span>

<span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Models<span class="token punctuation">\</span>Url</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token package">Illuminate<span class="token punctuation">\</span>Database<span class="token punctuation">\</span>Eloquent<span class="token punctuation">\</span>Factories<span class="token punctuation">\</span>Factory</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">UrlFactory</span> <span class="token keyword">extends</span> <span class="token class-name">Factory</span>
<span class="token punctuation">{</span>
    <span class="token comment">/**
     * The name of the factory's corresponding model.
     *
     * @var string
     */</span>
    <span class="token keyword">protected</span> <span class="token variable">$model</span> <span class="token operator">=</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * Define the model's default state.
     *
     * @return array
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">definition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token comment">//</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre></div><p>We don't need to add a lot to our factory as our table only really has one interesting column which is the url column. Factories also give us access to <a href="https://github.com/FakerPHP/Faker" target="_blank" rel="noopener noreferrer">Faker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> which is a php library that generates fake data. Lets go ahead and add a fake url to our Factory definition:</p> <div class="language-php extra-class"><pre class="language-php"><code>    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">definition</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span>
            <span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token property">faker</span><span class="token operator">-&gt;</span><span class="token property">url</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Now that we have this model factory lets go ahead and try using it in our test:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// tests/Feature/UrlTest.php</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">test_we_create_a_url_record</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token function">factory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ... rest of the test ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>with this new list we are creating 10 urls before our user creates one, let's see if our test still passes.</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Failed asserting that <span class="token string">'c'</span> matches expected <span class="token number">11</span>.
</code></pre></div><p>Now that our test is working as expected, and failing, let's fix it. Now if we run our server and create enough records to get past <code>id</code> 10 we should see something like this:</p> <img src="/tinyuri/08_base_62.png" alt="base62 url"> <p>Thats great but if we visit that url (<code>http://localhost:8000/url/f</code>) it is not going to work, we should see a 404. This is due to our implicit model route binding not finding a row with id <code>f</code>.</p> <h2 id="explicit-binding-and-scopes"><a href="#explicit-binding-and-scopes" class="header-anchor">#</a> Explicit binding and Scopes</h2> <p>Now we want to switch to explicit model binding. We already have a test that checks our redirects work correctly, lets update it with our new desired outcome:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// tests/Feature/UrlTest.php</span>

<span class="token variable">$url</span> <span class="token operator">=</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token string single-quoted-string">'https://www.google.com'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token property">id</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'shortened'</span><span class="token punctuation">,</span> <span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token function">base62id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$response</span><span class="token operator">-&gt;</span><span class="token function">assertRedirect</span><span class="token punctuation">(</span><span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token property">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We've gone ahead and updated the test to have an id above 9, and started using the handy <code>route()</code> helper. Our test is now failing with</p> <div class="language-sh extra-class"><pre class="language-sh"><code>Response status code <span class="token punctuation">[</span><span class="token number">404</span><span class="token punctuation">]</span> is not a redirect status code.
</code></pre></div><p>Before we can create our new model binding we need to add a way to find these models with their <code>base62id</code>. Lets create a <a href="https://laravel.com/docs/8.x/eloquent#query-scopes" target="_blank" rel="noopener noreferrer">scope<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> that can take in a <code>base62id</code> and convert it to an id and return the appropriate record.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// app/models/Url.php</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">scopeFromBase62</span><span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token variable">$base62</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$id</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">to10</span><span class="token punctuation">(</span><span class="token variable">$base62</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token operator">-&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'id'</span><span class="token punctuation">,</span> <span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>This will convert the id and return a query where the id is equal to the converting base10 version of what was passed in.</p> <p>Lets take a look at the <a href="https://laravel.com/docs/8.x/routing#explicit-binding" target="_blank" rel="noopener noreferrer">explicit model binding documentation<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>. It looks like we need to go into our <code>RouteServiceProvider.php</code> and update the logic for our <code>Url</code> model within the <code>boot()</code> function:</p> <div class="language-php extra-class"><pre class="language-php"><code>    <span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token function">fromBase62</span><span class="token punctuation">(</span><span class="token variable">$value</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">firstOrFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now if we run the tests or visit the url we should see it works as expected! Great, we have fully implemented the feature of using shorter urls.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tinyuri/basic_style.html" class="prev">
        Basic styling
      </a></span> <span class="next"><a href="/tinyuri/cleanup.html">
        Refactoring
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/tinyuri/assets/js/app.3bb2924c.js" defer></script><script src="/tinyuri/assets/js/2.a48eb182.js" defer></script><script src="/tinyuri/assets/js/13.9ce1fb47.js" defer></script>
  </body>
</html>
