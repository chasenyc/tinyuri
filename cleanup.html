<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Refactoring | Laravel URL Shortener Guide</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/tinyuri/assets/css/0.styles.d2ccf6e6.css" as="style"><link rel="preload" href="/tinyuri/assets/js/app.3bb2924c.js" as="script"><link rel="preload" href="/tinyuri/assets/js/2.a48eb182.js" as="script"><link rel="preload" href="/tinyuri/assets/js/11.95d99df8.js" as="script"><link rel="prefetch" href="/tinyuri/assets/js/10.6d1ed9c6.js"><link rel="prefetch" href="/tinyuri/assets/js/12.f1f697df.js"><link rel="prefetch" href="/tinyuri/assets/js/13.9ce1fb47.js"><link rel="prefetch" href="/tinyuri/assets/js/14.4cebca7a.js"><link rel="prefetch" href="/tinyuri/assets/js/15.3a6bf7d5.js"><link rel="prefetch" href="/tinyuri/assets/js/16.09b13ee9.js"><link rel="prefetch" href="/tinyuri/assets/js/17.37ce4089.js"><link rel="prefetch" href="/tinyuri/assets/js/18.7b9085b3.js"><link rel="prefetch" href="/tinyuri/assets/js/19.bd1170b4.js"><link rel="prefetch" href="/tinyuri/assets/js/20.4a35bc46.js"><link rel="prefetch" href="/tinyuri/assets/js/3.f153be8f.js"><link rel="prefetch" href="/tinyuri/assets/js/4.4d31d94d.js"><link rel="prefetch" href="/tinyuri/assets/js/5.4e7a2df9.js"><link rel="prefetch" href="/tinyuri/assets/js/6.498ab014.js"><link rel="prefetch" href="/tinyuri/assets/js/7.7e550121.js"><link rel="prefetch" href="/tinyuri/assets/js/8.fbde365e.js"><link rel="prefetch" href="/tinyuri/assets/js/9.b751af4a.js">
    <link rel="stylesheet" href="/tinyuri/assets/css/0.styles.d2ccf6e6.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/tinyuri/" class="home-link router-link-active"><!----> <span class="site-name">Laravel URL Shortener Guide</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/tinyuri/" class="nav-link">
  Guide
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/tinyuri/" class="nav-link">
  Guide
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Guide</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tinyuri/setting_up.html" class="sidebar-link">Setting up a project</a></li><li><a href="/tinyuri/mvp_design.html" class="sidebar-link">Planning</a></li><li><a href="/tinyuri/mvp_code.html" class="sidebar-link">Getting Started with Code</a></li><li><a href="/tinyuri/basic_style.html" class="sidebar-link">Basic styling</a></li><li><a href="/tinyuri/first_feature.html" class="sidebar-link">First feature</a></li><li><a href="/tinyuri/cleanup.html" aria-current="page" class="active sidebar-link">Refactoring</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/tinyuri/cleanup.html#adding-some-validations" class="sidebar-link">Adding some validations</a></li><li class="sidebar-sub-header"><a href="/tinyuri/cleanup.html#moving-logic-out-of-the-controller" class="sidebar-link">Moving logic out of the controller</a></li></ul></li><li><a href="/tinyuri/users.html" class="sidebar-link">Authentication</a></li><li><a href="/tinyuri/relationships.html" class="sidebar-link">Relationships</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="refactoring"><a href="#refactoring" class="header-anchor">#</a> Refactoring</h1> <h2 id="adding-some-validations"><a href="#adding-some-validations" class="header-anchor">#</a> Adding some validations</h2> <p>Now that we have implemented an MVP and added our first feature we should make a small addition to our application to validate that our user submitted urls are actually urls. Our end goal is to show an error to the user if the submit a bad url. Let's start with a small test, we are going to add to our feature test.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">test_we_return_an_error_for_invalid_url</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'google'</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/url'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token variable">$url</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span><span class="token operator">-&gt;</span><span class="token function">assertRedirect</span><span class="token punctuation">(</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$response</span><span class="token operator">-&gt;</span><span class="token function">assertSessionHasErrors</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Before we start implementing this logic, our routes file is starting to get a little busy. Let's try to move our logic out of the routes file(<code>web.php</code>) and into a controller. We can make our first controller like so:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>php artisan make:controller UrlController
</code></pre></div><p>We'll start with adding a store function to the controller and copy our logic from <code>web.php</code> into this function:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Request</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlId'</span> <span class="token operator">=&gt;</span> <span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token function">base62id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>now we can update the route to the following:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token class-name static-context">Route</span><span class="token operator">::</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'/url'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name static-context">UrlController</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'store'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'create'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If we run our tests they will still fail because we have yet to add any validations. So let's go ahead and add some validations within our Controller's store method:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'required'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'url'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'max:255'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>If we run our tests again they will now pass. All thats left is to add some frontend logic to display this to our users.</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token comment">&lt;!-- create.blade.php --&gt;</span>
@if ($urlId)
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>success message<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ route('shortened', ['url' =&gt; $urlId]) }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">&gt;</span></span>
@endif

@error('url')
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>error message<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{ $message }}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
@enderror
</code></pre></div><p>we now will display when there is an error returned from validation. We've gone ahead and made some computed styles for these messages that can be found in our <code>app.css</code>:</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">.success</span> <span class="token punctuation">{</span>
    <span class="token atrule"><span class="token rule">@apply</span>  text-green-700 bg-green-100 border border-green-300<span class="token punctuation">;</span></span>
<span class="token punctuation">}</span>

<span class="token selector">.error</span> <span class="token punctuation">{</span>
    <span class="token atrule"><span class="token rule">@apply</span> text-red-700 bg-red-100 border border-red-300<span class="token punctuation">;</span></span>
<span class="token punctuation">}</span>

<span class="token selector">.message</span> <span class="token punctuation">{</span>
    <span class="token atrule"><span class="token rule">@apply</span> border my-2 font-medium py-1 px-2 rounded-md<span class="token punctuation">;</span></span>
<span class="token punctuation">}</span>
</code></pre></div><p>And if we now test a bad url with our server we should see the following:</p> <img src="/tinyuri/09_error_message.png" alt="error message"> <h2 id="moving-logic-out-of-the-controller"><a href="#moving-logic-out-of-the-controller" class="header-anchor">#</a> Moving logic out of the controller</h2> <p>Now that we moved all of our logic out of the route file and into a controller, let's move that validation logic out of the controller to keep our controllers as small as possible. Laravel comes with robust form request validation that we are going to take advantage to isolate our request validation. Lets make a new form request:</p> <div class="language-sh extra-class"><pre class="language-sh"><code>php artisan make:request StoreUrlRequest
</code></pre></div><p>This is going to make a new file <code>app/Http/Requests/StoreUrlRequest.php</code>. Lets go ahead and use that file in our <code>UrlController</code></p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">use</span> <span class="token package">App<span class="token punctuation">\</span>Http<span class="token punctuation">\</span>Requests<span class="token punctuation">\</span>StoreUrlRequest</span><span class="token punctuation">;</span>
</code></pre></div><p>and then in our store function lets change our method signature from a plain request to a <code>StoreUrlRequest</code> and remove the request validation from the function:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">store</span><span class="token punctuation">(</span><span class="token class-name type-declaration">StoreUrlRequest</span> <span class="token variable">$request</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$url</span> <span class="token operator">=</span> <span class="token class-name static-context">Url</span><span class="token operator">::</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token variable">$request</span><span class="token operator">-&gt;</span><span class="token function">input</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token function">redirect</span><span class="token punctuation">(</span><span class="token function">route</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'home'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">with</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'urlId'</span> <span class="token operator">=&gt;</span> <span class="token variable">$url</span><span class="token operator">-&gt;</span><span class="token function">base62id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>lastly within the <code>StoreUrlRequest</code> lets add the following:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">/**
 * Get the validation rules that apply to the request.
 *
 * @return array
 */</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">[</span>
        <span class="token string single-quoted-string">'url'</span> <span class="token operator">=&gt;</span> <span class="token punctuation">[</span><span class="token string single-quoted-string">'required'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'url'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'max:255'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Let's also remove the <code>authorize()</code> function for now as we are not utilizing any authorization for the moment. If we run the tests again they should still pass. We now have a specific file dedicated to validating user input, we have a lean controller and we have a better functioning product.</p> <p>Next up, lets tackle creating users who can keep track of their shortened links.</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tinyuri/first_feature.html" class="prev">
        First feature
      </a></span> <span class="next"><a href="/tinyuri/users.html">
        Authentication
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/tinyuri/assets/js/app.3bb2924c.js" defer></script><script src="/tinyuri/assets/js/2.a48eb182.js" defer></script><script src="/tinyuri/assets/js/11.95d99df8.js" defer></script>
  </body>
</html>
